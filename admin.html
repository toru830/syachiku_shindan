<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ç”»é¢ - ç¤¾ç•œè¨ºæ–­ Analytics</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ç®¡ç†è€…ç”»é¢å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .admin-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .admin-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
        }
        
        .stat-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.85rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .chart {
            height: 200px;
            display: flex;
            align-items: end;
            gap: 8px;
            padding: 15px 0;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .chart-bar:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: scaleY(1.05);
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #718096;
            white-space: nowrap;
            writing-mode: horizontal-tb;
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: #2d3748;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table th {
            background: #f7fafc;
            font-weight: bold;
            color: #2d3748;
        }
        
        .table tr:hover {
            background: #f7fafc;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #718096;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
        }
        
        .auth-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .auth-error {
            color: #e53e3e;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .back-to-site {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .back-to-site:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart {
                height: 200px;
            }
            
            .chart-label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-to-site">â† ã‚µã‚¤ãƒˆã«æˆ»ã‚‹</a>
    
    <div class="admin-container">
        <!-- èªè¨¼ç”»é¢ -->
        <div id="auth-screen" class="auth-container">
            <h1 class="auth-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <input type="password" id="admin-password" class="auth-input" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
            <button id="login-btn" class="auth-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="auth-error" class="auth-error" style="display: none;"></div>
        </div>
        
        <!-- ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div id="dashboard" style="display: none;">
            <div class="admin-header">
                <h1 class="admin-title">ç¤¾ç•œè¨ºæ–­ Analytics</h1>
                <p class="admin-subtitle">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</p>
            </div>
            
            <button id="refresh-btn" class="refresh-btn">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
            <button id="export-btn" class="refresh-btn" style="margin-left: 10px; background: linear-gradient(135deg, #48bb78, #38a169);">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button id="debug-btn" class="refresh-btn" style="margin-left: 10px; background: linear-gradient(135deg, #e53e3e, #c53030);">ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
            
            <!-- åŸºæœ¬çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·è¨ºæ–­æ•°</h3>
                    <div class="stat-value" id="total-diagnoses">-</div>
                    <div class="stat-label">ç´¯è¨ˆè¨ºæ–­å®Œäº†æ•°</div>
                </div>
                <div class="stat-card">
                    <h3>ä»Šæ—¥ã®è¨ºæ–­æ•°</h3>
                    <div class="stat-value" id="today-diagnoses">-</div>
                    <div class="stat-label">æœ¬æ—¥ã®è¨ºæ–­å®Œäº†æ•°</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡ç¤¾ç•œãƒ¬ãƒ™ãƒ«</h3>
                    <div class="stat-value" id="avg-shachu-level">-</div>
                    <div class="stat-label">å…¨è¨ºæ–­ã®å¹³å‡å€¤</div>
                </div>
                <div class="stat-card">
                    <h3>äººæ°—No.1ã‚¿ã‚¤ãƒ—</h3>
                    <div class="stat-value" id="popular-type">-</div>
                    <div class="stat-label">æœ€ã‚‚å¤šã„è¨ºæ–­çµæœ</div>
                </div>
                <div class="stat-card">
                    <h3>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</h3>
                    <div class="stat-value" id="data-source">-</div>
                    <div class="stat-label">Google Sheets / ãƒ­ãƒ¼ã‚«ãƒ«</div>
                </div>
            </div>
            
            <!-- è¨ºæ–­çµæœåˆ†å¸ƒ -->
            <div class="chart-container">
                <h2 class="chart-title">è¨ºæ–­çµæœåˆ†å¸ƒ</h2>
                <div class="chart" id="result-distribution-chart">
                    <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
            
            <!-- ç¤¾ç•œãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ -->
            <div class="chart-container">
                <h2 class="chart-title">ç¤¾ç•œãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ</h2>
                <div class="chart" id="level-distribution-chart">
                    <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
            
            <!-- æ™‚é–“åˆ¥è¨ºæ–­æ•° -->
            <div class="chart-container">
                <h2 class="chart-title">æ™‚é–“åˆ¥è¨ºæ–­æ•°ï¼ˆ24æ™‚é–“ï¼‰</h2>
                <div class="chart" id="hourly-chart">
                    <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
            
            <!-- ãƒ‡ãƒã‚¤ã‚¹çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã‚¢ã‚¯ã‚»ã‚¹</h3>
                    <div id="device-stats">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>ãƒ–ãƒ©ã‚¦ã‚¶åˆ¥ã‚¢ã‚¯ã‚»ã‚¹</h3>
                    <div id="browser-stats">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- æœ€è¿‘ã®è¨ºæ–­çµæœ -->
            <div class="data-table">
                <h2 class="chart-title">æœ€è¿‘ã®è¨ºæ–­çµæœ</h2>
                <table class="table" id="recent-results">
                    <thead>
                        <tr>
                            <th>æ—¥æ™‚</th>
                            <th>çµæœã‚¿ã‚¤ãƒ—</th>
                            <th>ç¤¾ç•œãƒ¬ãƒ™ãƒ«</th>
                            <th>çŒ®èº«åº¦</th>
                            <th>çŠ ç‰²åº¦</th>
                            <th>ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§</th>
                            <th>äººé–“é–¢ä¿‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="firebase-config.js"></script>
    <script src="sheets-api.js"></script>
    <script>
        // ç®¡ç†è€…èªè¨¼
        const ADMIN_PASSWORD = 'syachiku_admin_2024'; // å®Ÿéš›ã®é‹ç”¨ã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨
        
        document.getElementById('login-btn').addEventListener('click', function() {
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('auth-error');
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆLocalAnalyticsã®åˆæœŸåŒ–ã‚’å¾…ã¤ï¼‰
                setTimeout(() => {
                    loadAnalyticsData();
                }, 100);
            } else {
                errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                errorDiv.style.display = 'block';
            }
        });
        
        // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('admin-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
        
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
        document.getElementById('refresh-btn').addEventListener('click', loadAnalyticsData);
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
        document.getElementById('export-btn').addEventListener('click', function() {
            exportData();
        });
        
        // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³
        document.getElementById('debug-btn').addEventListener('click', function() {
            console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
            console.log('LocalAnalytics:', window.LocalAnalytics);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å†…å®¹ã‚’ç¢ºèª
            const analyticsData = localStorage.getItem('syachiku_analytics');
            const pageViewData = localStorage.getItem('syachiku_pageviews');
            const clickData = localStorage.getItem('syachiku_clicks');
            const eventData = localStorage.getItem('syachiku_events');
            
            console.log('syachiku_analytics:', analyticsData);
            console.log('syachiku_pageviews:', pageViewData);
            console.log('syachiku_clicks:', clickData);
            console.log('syachiku_events:', eventData);
            
            // ãƒ‘ãƒ¼ã‚¹ã—ã¦ç¢ºèª
            try {
                const parsedAnalytics = JSON.parse(analyticsData || '[]');
                console.log('è§£æã•ã‚ŒãŸè¨ºæ–­ãƒ‡ãƒ¼ã‚¿:', parsedAnalytics);
                console.log('è¨ºæ–­ãƒ‡ãƒ¼ã‚¿æ•°:', parsedAnalytics.length);
                
                // ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚’è¡¨ç¤º
                if (parsedAnalytics.length > 0) {
                    console.log('æœ€æ–°ã®è¨ºæ–­ãƒ‡ãƒ¼ã‚¿:', parsedAnalytics[0]);
                }
            } catch (e) {
                console.error('è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', e);
            }
            
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ä¸­...');
            if (window.LocalAnalytics) {
                const testData = {
                    resultType: 'ãƒ†ã‚¹ãƒˆç¤¾ç•œ',
                    shachuLevel: 50,
                    scores: { dedication: 60, sacrifice: 40, stress: 70, relationship: 80 },
                    rawScores: { dedication: 30, sacrifice: 20, stress: 35, relationship: 40 },
                    typeIndex: 0,
                    timestamp: new Date()
                };
                window.LocalAnalytics.saveDiagnosisResult(testData);
                console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }
            
            alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚è¿½åŠ ã—ã¾ã—ãŸã€‚F12ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        });
        
        // QRã‚³ãƒ¼ãƒ‰å…±æœ‰ãƒœã‚¿ãƒ³
        document.getElementById('qr-share-btn').addEventListener('click', function() {
            const shareUrl = 'https://shindan.syachiku-life.com/';
            
            // QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const qrModal = document.createElement('div');
            qrModal.id = 'admin-qr-modal';
            qrModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            qrModal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 90%;
                    max-height: 90%;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                ">
                    <h3 style="margin-bottom: 20px; color: #2d3748;">ğŸ“± è¨ºæ–­ã‚µã‚¤ãƒˆã‚’å…±æœ‰</h3>
                    <div id="admin-qrcode" style="margin: 20px 0;"></div>
                    <p style="margin: 15px 0; color: #718096; font-size: 0.9rem;">
                        QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦è¨ºæ–­ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹<br>
                        ã‚¹ãƒãƒ›ã§è¨ºæ–­å¾Œã€ã“ã®ç®¡ç†è€…ç”»é¢ã§çµæœã‚’ç¢ºèªã§ãã¾ã™
                    </p>
                    <div style="margin: 20px 0;">
                        <button id="copy-admin-url-btn" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                            transition: all 0.3s ease;
                        ">ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼</button>
                        <button id="open-diagnosis-btn" style="
                            background: linear-gradient(135deg, #48bb78, #38a169);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                            transition: all 0.3s ease;
                        ">ğŸ”— è¨ºæ–­ã‚µã‚¤ãƒˆã‚’é–‹ã</button>
                    </div>
                    <button id="close-admin-qr-btn" style="
                        background: #e53e3e;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        cursor: pointer;
                        margin-top: 10px;
                    ">âœ• é–‰ã˜ã‚‹</button>
                </div>
            `;
            
            document.body.appendChild(qrModal);
            
            // QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(document.getElementById('admin-qrcode'), shareUrl, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#2d3748',
                        light: '#ffffff'
                    }
                }, function (error) {
                    if (error) {
                        console.error('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                        document.getElementById('admin-qrcode').innerHTML = '<p style="color: #e53e3e;">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                    }
                });
            } else {
                document.getElementById('admin-qrcode').innerHTML = '<p style="color: #e53e3e;">QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('copy-admin-url-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    this.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                    this.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                    setTimeout(() => {
                        this.textContent = 'ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼';
                        this.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    }, 2000);
                }).catch(() => {
                    alert('URLã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + shareUrl);
                });
            });
            
            document.getElementById('open-diagnosis-btn').addEventListener('click', function() {
                window.open(shareUrl, '_blank');
            });
            
            document.getElementById('close-admin-qr-btn').addEventListener('click', function() {
                qrModal.remove();
            });
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            qrModal.addEventListener('click', function(e) {
                if (e.target === qrModal) {
                    qrModal.remove();
                }
            });
        });
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è¨ºæ–­çµæœã‚’èª­ã¿è¾¼ã¿
        function loadResultFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const resultParam = urlParams.get('result');
                
                if (resultParam) {
                    console.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰çµæœã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    const resultData = JSON.parse(atob(resultParam));
                    console.log('URLã‹ã‚‰èª­ã¿è¾¼ã‚“ã çµæœ:', resultData);
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    if (window.LocalAnalytics) {
                        window.LocalAnalytics.saveDiagnosisResult(resultData);
                        console.log('URLã‹ã‚‰èª­ã¿è¾¼ã‚“ã çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ');
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadAnalyticsData() {
            try {
                console.log('ç®¡ç†è€…ç”»é¢: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                
                // ã¾ãšURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰çµæœã‚’èª­ã¿è¾¼ã¿
                const urlResultLoaded = loadResultFromURL();
                
                let results = [];
                
                // Google Sheetsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆä»–ç«¯æœ«ãƒ»åˆ¥ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã‚‚å…±æœ‰å¯èƒ½ï¼‰
                if (window.SheetsAPI) {
                    console.log('Google Sheetsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                    results = await window.SheetsAPI.getDiagnosisFromSheets();
                    console.log('Google Sheetsã‹ã‚‰å–å¾—ã—ãŸçµæœæ•°:', results.length);
                }
                
                // Google Sheetsã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
                if (results.length === 0 && window.LocalAnalytics) {
                    console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                    results = window.LocalAnalytics.getDiagnosisResults(1000);
                    console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã—ãŸçµæœæ•°:', results.length);
                }
                
                console.log('URLã‹ã‚‰çµæœã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', urlResultLoaded);
                
                if (results.length === 0) {
                    showError('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¨ºæ–­ã‚µã‚¤ãƒˆã§è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // çµ±è¨ˆã‚’è¨ˆç®—
                let stats;
                if (window.SheetsAPI) {
                    stats = window.SheetsAPI.calculateStatisticsFromSheets(results);
                } else if (window.LocalAnalytics) {
                    stats = window.LocalAnalytics.calculateStatistics(results);
                } else {
                    showError('Analyticsã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                // åŸºæœ¬çµ±è¨ˆã‚’æ›´æ–°
                updateBasicStats(stats);
                
                // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
                updateResultDistributionChart(stats.resultTypeDistribution);
                updateLevelDistributionChart(stats.shachuLevelDistribution);
                updateHourlyChart(stats.hourlyStats);
                updateDeviceStats(stats.deviceStats, stats.browserStats);
                
                // æœ€è¿‘ã®çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                updateRecentResultsTable(results.slice(0, 50));
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // åŸºæœ¬çµ±è¨ˆã‚’æ›´æ–°
        function updateBasicStats(stats) {
            document.getElementById('total-diagnoses').textContent = stats.totalDiagnoses.toLocaleString();
            
            // ä»Šæ—¥ã®è¨ºæ–­æ•°
            const today = new Date().toDateString();
            const todayCount = stats.dailyStats[today] || 0;
            document.getElementById('today-diagnoses').textContent = todayCount.toLocaleString();
            
            // å¹³å‡ç¤¾ç•œãƒ¬ãƒ™ãƒ«
            const avgLevel = results.reduce((sum, result) => sum + (result.shachuLevel || 0), 0) / results.length;
            document.getElementById('avg-shachu-level').textContent = Math.round(avgLevel);
            
            // äººæ°—No.1ã‚¿ã‚¤ãƒ—
            const popularType = Object.entries(stats.resultTypeDistribution)
                .sort(([,a], [,b]) => b - a)[0];
            document.getElementById('popular-type').textContent = popularType ? popularType[0] : '-';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
            const sheetsCount = stats.sourceStats?.sheets || 0;
            const localCount = stats.sourceStats?.local || 0;
            if (sheetsCount > 0) {
                document.getElementById('data-source').textContent = `Sheets: ${sheetsCount}`;
            } else if (localCount > 0) {
                document.getElementById('data-source').textContent = `Local: ${localCount}`;
            } else {
                document.getElementById('data-source').textContent = '-';
            }
        }
        
        // è¨ºæ–­çµæœåˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ
        function updateResultDistributionChart(distribution) {
            const chart = document.getElementById('result-distribution-chart');
            chart.innerHTML = '';
            
            const maxCount = Math.max(...Object.values(distribution));
            const entries = Object.entries(distribution).sort(([,a], [,b]) => b - a);
            
            entries.forEach(([type, count]) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(count / maxCount) * 100}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = type.length > 8 ? type.substring(0, 8) + '...' : type;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = count;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chart.appendChild(bar);
            });
        }
        
        // ç¤¾ç•œãƒ¬ãƒ™ãƒ«åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ
        function updateLevelDistributionChart(distribution) {
            const chart = document.getElementById('level-distribution-chart');
            chart.innerHTML = '';
            
            const maxCount = Math.max(...Object.values(distribution));
            const entries = Object.entries(distribution).sort(([a], [b]) => parseInt(a) - parseInt(b));
            
            entries.forEach(([range, count]) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(count / maxCount) * 100}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = range;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = count;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chart.appendChild(bar);
            });
        }
        
        // æ™‚é–“åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
        function updateHourlyChart(hourlyStats) {
            const chart = document.getElementById('hourly-chart');
            chart.innerHTML = '';
            
            const maxCount = Math.max(...Object.values(hourlyStats));
            
            for (let hour = 0; hour < 24; hour++) {
                const count = hourlyStats[hour] || 0;
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(count / maxCount) * 100}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = `${hour}:00`;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = count;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chart.appendChild(bar);
            }
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹çµ±è¨ˆ
        function updateDeviceStats(deviceStats, browserStats) {
            const deviceDiv = document.getElementById('device-stats');
            deviceDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>ãƒ¢ãƒã‚¤ãƒ«:</strong> ${deviceStats.mobile} (${Math.round(deviceStats.mobile / (deviceStats.mobile + deviceStats.desktop + deviceStats.tablet) * 100)}%)
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—:</strong> ${deviceStats.desktop} (${Math.round(deviceStats.desktop / (deviceStats.mobile + deviceStats.desktop + deviceStats.tablet) * 100)}%)
                </div>
                <div>
                    <strong>ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ:</strong> ${deviceStats.tablet} (${Math.round(deviceStats.tablet / (deviceStats.mobile + deviceStats.desktop + deviceStats.tablet) * 100)}%)
                </div>
            `;
            
            const browserDiv = document.getElementById('browser-stats');
            const browserEntries = Object.entries(browserStats).sort(([,a], [,b]) => b - a);
            browserDiv.innerHTML = browserEntries.map(([browser, count]) => 
                `<div style="margin-bottom: 5px;"><strong>${browser}:</strong> ${count}</div>`
            ).join('');
        }
        
        // æœ€è¿‘ã®çµæœãƒ†ãƒ¼ãƒ–ãƒ«
        function updateRecentResultsTable(results) {
            const tbody = document.querySelector('#recent-results tbody');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                const date = new Date(result.timestamp?.toDate?.() || result.timestamp);
                row.innerHTML = `
                    <td>${date.toLocaleString('ja-JP')}</td>
                    <td>${result.resultType || '-'}</td>
                    <td>${result.shachuLevel || 0}</td>
                    <td>${result.scores?.dedication || 0}%</td>
                    <td>${result.scores?.sacrifice || 0}%</td>
                    <td>${result.scores?.stress || 0}%</td>
                    <td>${result.scores?.relationship || 0}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.admin-container').insertBefore(errorDiv, document.querySelector('.admin-container').firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆä»–ã®é–¢æ•°ã§ä½¿ç”¨ï¼‰
        let results = [];
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            try {
                if (results.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã€Œãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // CSVå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                const csvContent = generateCSV(results);
                downloadCSV(csvContent, `syachiku_analytics_${new Date().toISOString().split('T')[0]}.csv`);
                
                // JSONå½¢å¼ã§ã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                const jsonContent = JSON.stringify(results, null, 2);
                downloadJSON(jsonContent, `syachiku_analytics_${new Date().toISOString().split('T')[0]}.json`);
                
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\n- CSVãƒ•ã‚¡ã‚¤ãƒ«: Excelã§é–‹ã‘ã¾ã™\n- JSONãƒ•ã‚¡ã‚¤ãƒ«: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‡¦ç†ã§ãã¾ã™');
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // CSVå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateCSV(data) {
            const headers = [
                'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—',
                'çµæœã‚¿ã‚¤ãƒ—',
                'ç¤¾ç•œãƒ¬ãƒ™ãƒ«',
                'çŒ®èº«åº¦',
                'çŠ ç‰²åº¦',
                'ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§',
                'äººé–“é–¢ä¿‚',
                'ç”ŸçŒ®èº«åº¦',
                'ç”ŸçŠ ç‰²åº¦',
                'ç”Ÿã‚¹ãƒˆãƒ¬ã‚¹è€æ€§',
                'ç”Ÿäººé–“é–¢ä¿‚',
                'ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹',
                'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ',
                'ç”»é¢è§£åƒåº¦',
                'è¨€èª',
                'URL'
            ];
            
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = [
                    `"${row.timestamp || ''}"`,
                    `"${row.resultType || ''}"`,
                    row.shachuLevel || 0,
                    row.scores?.dedication || 0,
                    row.scores?.sacrifice || 0,
                    row.scores?.stress || 0,
                    row.scores?.relationship || 0,
                    row.rawScores?.dedication || 0,
                    row.rawScores?.sacrifice || 0,
                    row.rawScores?.stress || 0,
                    row.rawScores?.relationship || 0,
                    row.typeIndex || 0,
                    `"${row.userAgent || ''}"`,
                    `"${row.screenResolution || ''}"`,
                    `"${row.language || ''}"`,
                    `"${row.url || ''}"`
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadJSON(content, filename) {
            const blob = new Blob([content], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
