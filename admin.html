<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÆ°ÁêÜËÄÖÁîªÈù¢ - Á§æÁïúË®∫Êñ≠ Analytics</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ÁÆ°ÁêÜËÄÖÁîªÈù¢Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .admin-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .admin-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
        }
        
        .stat-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.85rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .chart {
            height: 200px;
            display: flex;
            align-items: end;
            gap: 8px;
            padding: 15px 0;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .chart-bar:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: scaleY(1.05);
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #718096;
            white-space: nowrap;
            writing-mode: horizontal-tb;
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: #2d3748;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table th {
            background: #f7fafc;
            font-weight: bold;
            color: #2d3748;
        }
        
        .table tr:hover {
            background: #f7fafc;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #718096;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
        }
        
        .auth-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .auth-error {
            color: #e53e3e;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .back-to-site {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .back-to-site:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart {
                height: 200px;
            }
            
            .chart-label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-to-site">‚Üê „Çµ„Ç§„Éà„Å´Êàª„Çã</a>
    
    <div class="admin-container">
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="auth-screen" class="auth-container">
            <h1 class="auth-title">ÁÆ°ÁêÜËÄÖ„É≠„Ç∞„Ç§„É≥</h1>
            <input type="password" id="admin-password" class="auth-input" placeholder="ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ" autocomplete="current-password">
            <button id="login-btn" class="auth-btn">„É≠„Ç∞„Ç§„É≥</button>
            <div id="auth-error" class="auth-error" style="display: none;"></div>
        </div>
        
        <!-- ÁÆ°ÁêÜËÄÖ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
        <div id="dashboard" style="display: none;">
            <div class="admin-header">
                <h1 class="admin-title">Á§æÁïúË®∫Êñ≠ Analytics</h1>
                <p class="admin-subtitle">„É™„Ç¢„É´„Çø„Ç§„É†Áµ±Ë®à„Éá„Éº„Çø</p>
            </div>
            
            <button id="refresh-btn" class="refresh-btn">üîÑ „Éá„Éº„Çø„ÇíÊõ¥Êñ∞</button>
            <button id="export-btn" class="refresh-btn" style="margin-left: 10px; background: linear-gradient(135deg, #48bb78, #38a169);">üìä „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            <button id="debug-btn" class="refresh-btn" style="margin-left: 10px; background: linear-gradient(135deg, #e53e3e, #c53030);">üêõ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</button>
            
            <!-- Âü∫Êú¨Áµ±Ë®à -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Á∑èË®∫Êñ≠Êï∞</h3>
                    <div class="stat-value" id="total-diagnoses">-</div>
                    <div class="stat-label">Á¥ØË®àË®∫Êñ≠ÂÆå‰∫ÜÊï∞</div>
                </div>
                <div class="stat-card">
                    <h3>‰ªäÊó•„ÅÆË®∫Êñ≠Êï∞</h3>
                    <div class="stat-value" id="today-diagnoses">-</div>
                    <div class="stat-label">Êú¨Êó•„ÅÆË®∫Êñ≠ÂÆå‰∫ÜÊï∞</div>
                </div>
                <div class="stat-card">
                    <h3>Âπ≥ÂùáÁ§æÁïú„É¨„Éô„É´</h3>
                    <div class="stat-value" id="avg-shachu-level">-</div>
                    <div class="stat-label">ÂÖ®Ë®∫Êñ≠„ÅÆÂπ≥ÂùáÂÄ§</div>
                </div>
                <div class="stat-card">
                    <h3>‰∫∫Ê∞óNo.1„Çø„Ç§„Éó</h3>
                    <div class="stat-value" id="popular-type">-</div>
                    <div class="stat-label">ÊúÄ„ÇÇÂ§ö„ÅÑË®∫Êñ≠ÁµêÊûú</div>
                </div>
                <div class="stat-card">
                    <h3>„Éá„Éº„Çø„ÇΩ„Éº„Çπ</h3>
                    <div class="stat-value" id="data-source">-</div>
                    <div class="stat-label">Google Sheets / „É≠„Éº„Ç´„É´</div>
                </div>
            </div>
            
            <!-- Ë®∫Êñ≠ÁµêÊûúÂàÜÂ∏É -->
            <div class="chart-container">
                <h2 class="chart-title">Ë®∫Êñ≠ÁµêÊûúÂàÜÂ∏É</h2>
                <div class="chart" id="result-distribution-chart">
                    <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>
            
            <!-- Á§æÁïú„É¨„Éô„É´ÂàÜÂ∏É -->
            <div class="chart-container">
                <h2 class="chart-title">Á§æÁïú„É¨„Éô„É´ÂàÜÂ∏É</h2>
                <div class="chart" id="level-distribution-chart">
                    <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>
            
            <!-- ÊôÇÈñìÂà•Ë®∫Êñ≠Êï∞ -->
            <div class="chart-container">
                <h2 class="chart-title">ÊôÇÈñìÂà•Ë®∫Êñ≠Êï∞Ôºà24ÊôÇÈñìÔºâ</h2>
                <div class="chart" id="hourly-chart">
                    <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>
            
            <!-- „Éá„Éê„Ç§„ÇπÁµ±Ë®à -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>„Éá„Éê„Ç§„ÇπÂà•„Ç¢„ÇØ„Çª„Çπ</h3>
                    <div id="device-stats">
                        <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>„Éñ„É©„Ç¶„Ç∂Âà•„Ç¢„ÇØ„Çª„Çπ</h3>
                    <div id="browser-stats">
                        <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
            </div>
            
            <!-- ÊúÄËøë„ÅÆË®∫Êñ≠ÁµêÊûú -->
            <div class="data-table">
                <h2 class="chart-title">ÊúÄËøë„ÅÆË®∫Êñ≠ÁµêÊûú</h2>
                <table class="table" id="recent-results">
                    <thead>
                        <tr>
                            <th>Êó•ÊôÇ</th>
                            <th>ÁµêÊûú„Çø„Ç§„Éó</th>
                            <th>Á§æÁïú„É¨„Éô„É´</th>
                            <th>ÁåÆË∫´Â∫¶</th>
                            <th>Áä†Áâ≤Â∫¶</th>
                            <th>„Çπ„Éà„É¨„ÇπËÄêÊÄß</th>
                            <th>‰∫∫ÈñìÈñ¢‰øÇ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="firebase-config.js"></script>
    <script src="sheets-api.js"></script>
    <script>
        // ÁÆ°ÁêÜËÄÖË™çË®º
        const ADMIN_PASSWORD = 'syachiku_admin_2024'; // ÂÆüÈöõ„ÅÆÈÅãÁî®„Åß„ÅØÁí∞Â¢ÉÂ§âÊï∞„Çí‰ΩøÁî®
        
        document.getElementById('login-btn').addEventListener('click', function() {
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('auth-error');
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÅøÔºàLocalAnalytics„ÅÆÂàùÊúüÂåñ„ÇíÂæÖ„Å§Ôºâ
                setTimeout(() => {
                    loadAnalyticsData();
                }, 100);
            } else {
                errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì';
                errorDiv.style.display = 'block';
            }
        });
        
        // Enter„Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
        document.getElementById('admin-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
        
        // „Éá„Éº„ÇøÊõ¥Êñ∞„Éú„Çø„É≥
        document.getElementById('refresh-btn').addEventListener('click', loadAnalyticsData);
        
        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥
        document.getElementById('export-btn').addEventListener('click', function() {
            exportData();
        });
        
        // „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥
        document.getElementById('debug-btn').addEventListener('click', function() {
            console.log('=== „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± ===');
            console.log('LocalAnalytics:', window.LocalAnalytics);
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
            const analyticsData = localStorage.getItem('syachiku_analytics');
            const pageViewData = localStorage.getItem('syachiku_pageviews');
            const clickData = localStorage.getItem('syachiku_clicks');
            const eventData = localStorage.getItem('syachiku_events');
            
            console.log('syachiku_analytics:', analyticsData);
            console.log('syachiku_pageviews:', pageViewData);
            console.log('syachiku_clicks:', clickData);
            console.log('syachiku_events:', eventData);
            
            // „Éë„Éº„Çπ„Åó„Å¶Á¢∫Ë™ç
            try {
                const parsedAnalytics = JSON.parse(analyticsData || '[]');
                console.log('Ëß£Êûê„Åï„Çå„ÅüË®∫Êñ≠„Éá„Éº„Çø:', parsedAnalytics);
                console.log('Ë®∫Êñ≠„Éá„Éº„ÇøÊï∞:', parsedAnalytics.length);
                
                // „Éá„Éº„Çø„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                if (parsedAnalytics.length > 0) {
                    console.log('ÊúÄÊñ∞„ÅÆË®∫Êñ≠„Éá„Éº„Çø:', parsedAnalytics[0]);
                }
            } catch (e) {
                console.error('Ë®∫Êñ≠„Éá„Éº„Çø„ÅÆËß£Êûê„Ç®„É©„Éº:', e);
            }
            
            // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíËøΩÂä†
            console.log('„ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíËøΩÂä†‰∏≠...');
            if (window.LocalAnalytics) {
                const testData = {
                    resultType: '„ÉÜ„Çπ„ÉàÁ§æÁïú',
                    shachuLevel: 50,
                    scores: { dedication: 60, sacrifice: 40, stress: 70, relationship: 80 },
                    rawScores: { dedication: 30, sacrifice: 20, stress: 35, relationship: 40 },
                    typeIndex: 0,
                    timestamp: new Date()
                };
                window.LocalAnalytics.saveDiagnosisResult(testData);
                console.log('„ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
            }
            
            alert('„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ„Åó„Åæ„Åó„Åü„ÄÇ„ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇÇËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇF12„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        });
        
        // QR„Ç≥„Éº„ÉâÂÖ±Êúâ„Éú„Çø„É≥
        document.getElementById('qr-share-btn').addEventListener('click', function() {
            const shareUrl = 'https://shindan.syachiku-life.com/';
            
            // QR„Ç≥„Éº„Éâ„É¢„Éº„ÉÄ„É´„Çí‰ΩúÊàê
            const qrModal = document.createElement('div');
            qrModal.id = 'admin-qr-modal';
            qrModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            qrModal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 90%;
                    max-height: 90%;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                ">
                    <h3 style="margin-bottom: 20px; color: #2d3748;">üì± Ë®∫Êñ≠„Çµ„Ç§„Éà„ÇíÂÖ±Êúâ</h3>
                    <div id="admin-qrcode" style="margin: 20px 0;"></div>
                    <p style="margin: 15px 0; color: #718096; font-size: 0.9rem;">
                        QR„Ç≥„Éº„Éâ„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶Ë®∫Êñ≠„Çµ„Ç§„Éà„Å´„Ç¢„ÇØ„Çª„Çπ<br>
                        „Çπ„Éû„Éõ„ÅßË®∫Êñ≠Âæå„ÄÅ„Åì„ÅÆÁÆ°ÁêÜËÄÖÁîªÈù¢„ÅßÁµêÊûú„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô
                    </p>
                    <div style="margin: 20px 0;">
                        <button id="copy-admin-url-btn" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                            transition: all 0.3s ease;
                        ">üìã URL„Çí„Ç≥„Éî„Éº</button>
                        <button id="open-diagnosis-btn" style="
                            background: linear-gradient(135deg, #48bb78, #38a169);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 5px;
                            transition: all 0.3s ease;
                        ">üîó Ë®∫Êñ≠„Çµ„Ç§„Éà„ÇíÈñã„Åè</button>
                    </div>
                    <button id="close-admin-qr-btn" style="
                        background: #e53e3e;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        cursor: pointer;
                        margin-top: 10px;
                    ">‚úï Èñâ„Åò„Çã</button>
                </div>
            `;
            
            document.body.appendChild(qrModal);
            
            // QR„Ç≥„Éº„Éâ„ÇíÁîüÊàê
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(document.getElementById('admin-qrcode'), shareUrl, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#2d3748',
                        light: '#ffffff'
                    }
                }, function (error) {
                    if (error) {
                        console.error('QR„Ç≥„Éº„ÉâÁîüÊàê„Ç®„É©„Éº:', error);
                        document.getElementById('admin-qrcode').innerHTML = '<p style="color: #e53e3e;">QR„Ç≥„Éº„ÉâÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
                    }
                });
            } else {
                document.getElementById('admin-qrcode').innerHTML = '<p style="color: #e53e3e;">QR„Ç≥„Éº„Éâ„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
            }
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('copy-admin-url-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    this.textContent = '‚úÖ „Ç≥„Éî„ÉºÂÆå‰∫ÜÔºÅ';
                    this.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                    setTimeout(() => {
                        this.textContent = 'üìã URL„Çí„Ç≥„Éî„Éº';
                        this.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    }, 2000);
                }).catch(() => {
                    alert('URL„Çí„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: ' + shareUrl);
                });
            });
            
            document.getElementById('open-diagnosis-btn').addEventListener('click', function() {
                window.open(shareUrl, '_blank');
            });
            
            document.getElementById('close-admin-qr-btn').addEventListener('click', function() {
                qrModal.remove();
            });
            
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            qrModal.addEventListener('click', function(e) {
                if (e.target === qrModal) {
                    qrModal.remove();
                }
            });
        });
        
        // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâË®∫Êñ≠ÁµêÊûú„ÇíË™≠„ÅøËæº„Åø
        function loadResultFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const resultParam = urlParams.get('result');
                
                if (resultParam) {
                    console.log('URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÁµêÊûú„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                    const resultData = JSON.parse(atob(resultParam));
                    console.log('URL„Åã„ÇâË™≠„ÅøËæº„Çì„Å†ÁµêÊûú:', resultData);
                    
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                    if (window.LocalAnalytics) {
                        window.LocalAnalytics.saveDiagnosisResult(resultData);
                        console.log('URL„Åã„ÇâË™≠„ÅøËæº„Çì„Å†ÁµêÊûú„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                    }
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('URL„Éë„É©„É°„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                return false;
            }
        }

        // ÂàÜÊûê„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        async function loadAnalyticsData() {
            try {
                console.log('ÁÆ°ÁêÜËÄÖÁîªÈù¢: „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã');
                
                // „Åæ„ÅöURL„Éë„É©„É°„Éº„Çø„Åã„ÇâÁµêÊûú„ÇíË™≠„ÅøËæº„Åø
                const urlResultLoaded = loadResultFromURL();
                
                let results = [];
                
                // Google Sheets„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæóÔºà‰ªñÁ´ØÊú´„ÉªÂà•„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Åß„ÇÇÂÖ±ÊúâÂèØËÉΩÔºâ
                if (window.SheetsAPI) {
                    console.log('Google Sheets„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...');
                    results = await window.SheetsAPI.getDiagnosisFromSheets();
                    console.log('Google Sheets„Åã„ÇâÂèñÂæó„Åó„ÅüÁµêÊûúÊï∞:', results.length);
                }
                
                // Google Sheets„Åã„Çâ„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæó
                if (results.length === 0 && window.LocalAnalytics) {
                    console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...');
                    results = window.LocalAnalytics.getDiagnosisResults(1000);
                    console.log('„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂèñÂæó„Åó„ÅüÁµêÊûúÊï∞:', results.length);
                }
                
                console.log('URL„Åã„ÇâÁµêÊûú„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', urlResultLoaded);
                
                if (results.length === 0) {
                    showError('„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöË®∫Êñ≠„Çµ„Ç§„Éà„ÅßË®∫Êñ≠„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                // Áµ±Ë®à„ÇíË®àÁÆó
                let stats;
                if (window.SheetsAPI) {
                    stats = window.SheetsAPI.calculateStatisticsFromSheets(results);
                } else if (window.LocalAnalytics) {
                    stats = window.LocalAnalytics.calculateStatistics(results);
                } else {
                    showError('Analytics„Ç∑„Çπ„ÉÜ„É†„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                
                // Âü∫Êú¨Áµ±Ë®à„ÇíÊõ¥Êñ∞
                updateBasicStats(stats);
                
                // „ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞
                updateResultDistributionChart(stats.resultTypeDistribution);
                updateLevelDistributionChart(stats.shachuLevelDistribution);
                updateHourlyChart(stats.hourlyStats);
                updateDeviceStats(stats.deviceStats, stats.browserStats);
                
                // ÊúÄËøë„ÅÆÁµêÊûú„ÉÜ„Éº„Éñ„É´„ÇíÊõ¥Êñ∞
                updateRecentResultsTable(results.slice(0, 50));
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showError('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // Âü∫Êú¨Áµ±Ë®à„ÇíÊõ¥Êñ∞
        function updateBasicStats(stats) {
            document.getElementById('total-diagnoses').textContent = stats.totalDiagnoses.toLocaleString();
            
            // ‰ªäÊó•„ÅÆË®∫Êñ≠Êï∞
            const today = new Date().toDateString();
            const todayCount = stats.dailyStats[today] || 0;
            document.getElementById('today-diagnoses').textContent = todayCount.toLocaleString();
            
            // Âπ≥ÂùáÁ§æÁïú„É¨„Éô„É´
            const avgLevel = results.reduce((sum, result) => sum + (result.shachuLevel || 0), 0) / results.length;
            document.getElementById('avg-shachu-level').textContent = Math.round(avgLevel);
            
            // ‰∫∫Ê∞óNo.1„Çø„Ç§„Éó
            const popularType = Object.entries(stats.resultTypeDistribution)
                .sort(([,a], [,b]) => b - a)[0];
            document.getElementById('popular-type').textContent = popularType ? popularType[0] : '-';
            
            // „Éá„Éº„Çø„ÇΩ„Éº„Çπ
            const sheetsCount = stats.sourceStats?.sheets || 0;
            const localCount = stats.sourceStats?.local || 0;
            if (sheetsCount > 0) {
                document.getElementById('data-source').textContent = `Sheets: ${sheetsCount}`;
            } else if (localCount > 0) {
                document.getElementById('data-source').textContent = `Local: ${localCount}`;
            } else {
                document.getElementById('data-source').textContent = '-';
            }
        }
        
        // Ë®∫Êñ≠ÁµêÊûúÂàÜÂ∏É„ÉÅ„É£„Éº„Éà
        function updateResultDistributionChart(distribution) {
            const chart = document.getElementById('result-distribution-chart');
            chart.innerHTML = '';
            
            const maxCount = Math.max(...Object.values(distribution));
            const entries = Object.entries(distribution).sort(([,a], [,b]) => b - a);
            
            entries.forEach(([type, count]) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(count / maxCount) * 100}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = type.length > 8 ? type.substring(0, 8) + '...' : type;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = count;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chart.appendChild(bar);
            });
        }
        
        // Á§æÁïú„É¨„Éô„É´ÂàÜÂ∏É„ÉÅ„É£„Éº„Éà
        function updateLevelDistributionChart(distribution) {
            const chart = document.getElementById('level-distribution-chart');
            chart.innerHTML = '';
            
            const maxCount = Math.max(...Object.values(distribution));
            const entries = Object.entries(distribution).sort(([a], [b]) => parseInt(a) - parseInt(b));
            
            entries.forEach(([range, count]) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(count / maxCount) * 100}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = range;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = count;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chart.appendChild(bar);
            });
        }
        
        // ÊôÇÈñìÂà•„ÉÅ„É£„Éº„Éà
        function updateHourlyChart(hourlyStats) {
            const chart = document.getElementById('hourly-chart');
            chart.innerHTML = '';
            
            const maxCount = Math.max(...Object.values(hourlyStats));
            
            for (let hour = 0; hour < 24; hour++) {
                const count = hourlyStats[hour] || 0;
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(count / maxCount) * 100}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = `${hour}:00`;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = count;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chart.appendChild(bar);
            }
        }
        
        // „Éá„Éê„Ç§„ÇπÁµ±Ë®à
        function updateDeviceStats(deviceStats, browserStats) {
            const deviceDiv = document.getElementById('device-stats');
            deviceDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>„É¢„Éê„Ç§„É´:</strong> ${deviceStats.mobile} (${Math.round(deviceStats.mobile / (deviceStats.mobile + deviceStats.desktop + deviceStats.tablet) * 100)}%)
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó:</strong> ${deviceStats.desktop} (${Math.round(deviceStats.desktop / (deviceStats.mobile + deviceStats.desktop + deviceStats.tablet) * 100)}%)
                </div>
                <div>
                    <strong>„Çø„Éñ„É¨„ÉÉ„Éà:</strong> ${deviceStats.tablet} (${Math.round(deviceStats.tablet / (deviceStats.mobile + deviceStats.desktop + deviceStats.tablet) * 100)}%)
                </div>
            `;
            
            const browserDiv = document.getElementById('browser-stats');
            const browserEntries = Object.entries(browserStats).sort(([,a], [,b]) => b - a);
            browserDiv.innerHTML = browserEntries.map(([browser, count]) => 
                `<div style="margin-bottom: 5px;"><strong>${browser}:</strong> ${count}</div>`
            ).join('');
        }
        
        // ÊúÄËøë„ÅÆÁµêÊûú„ÉÜ„Éº„Éñ„É´
        function updateRecentResultsTable(results) {
            const tbody = document.querySelector('#recent-results tbody');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                const date = new Date(result.timestamp?.toDate?.() || result.timestamp);
                row.innerHTML = `
                    <td>${date.toLocaleString('ja-JP')}</td>
                    <td>${result.resultType || '-'}</td>
                    <td>${result.shachuLevel || 0}</td>
                    <td>${result.scores?.dedication || 0}%</td>
                    <td>${result.scores?.sacrifice || 0}%</td>
                    <td>${result.scores?.stress || 0}%</td>
                    <td>${result.scores?.relationship || 0}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.admin-container').insertBefore(errorDiv, document.querySelector('.admin-container').firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞Ôºà‰ªñ„ÅÆÈñ¢Êï∞„Åß‰ΩøÁî®Ôºâ
        let results = [];
        
        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
        function exportData() {
            try {
                if (results.length === 0) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„Åö„Äå„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                // CSVÂΩ¢Âºè„Åß„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                const csvContent = generateCSV(results);
                downloadCSV(csvContent, `syachiku_analytics_${new Date().toISOString().split('T')[0]}.csv`);
                
                // JSONÂΩ¢Âºè„Åß„ÇÇ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                const jsonContent = JSON.stringify(results, null, 2);
                downloadJSON(jsonContent, `syachiku_analytics_${new Date().toISOString().split('T')[0]}.json`);
                
                alert('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ\n- CSV„Éï„Ç°„Ç§„É´: Excel„ÅßÈñã„Åë„Åæ„Åô\n- JSON„Éï„Ç°„Ç§„É´: „Éó„É≠„Ç∞„É©„É†„ÅßÂá¶ÁêÜ„Åß„Åç„Åæ„Åô');
                
            } catch (error) {
                console.error('„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                alert('„Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }
        
        // CSVÂΩ¢Âºè„Åß„Éá„Éº„Çø„ÇíÁîüÊàê
        function generateCSV(data) {
            const headers = [
                '„Çø„Ç§„É†„Çπ„Çø„É≥„Éó',
                'ÁµêÊûú„Çø„Ç§„Éó',
                'Á§æÁïú„É¨„Éô„É´',
                'ÁåÆË∫´Â∫¶',
                'Áä†Áâ≤Â∫¶',
                '„Çπ„Éà„É¨„ÇπËÄêÊÄß',
                '‰∫∫ÈñìÈñ¢‰øÇ',
                'ÁîüÁåÆË∫´Â∫¶',
                'ÁîüÁä†Áâ≤Â∫¶',
                'Áîü„Çπ„Éà„É¨„ÇπËÄêÊÄß',
                'Áîü‰∫∫ÈñìÈñ¢‰øÇ',
                '„Çø„Ç§„Éó„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ',
                '„É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà',
                'ÁîªÈù¢Ëß£ÂÉèÂ∫¶',
                'Ë®ÄË™û',
                'URL'
            ];
            
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = [
                    `"${row.timestamp || ''}"`,
                    `"${row.resultType || ''}"`,
                    row.shachuLevel || 0,
                    row.scores?.dedication || 0,
                    row.scores?.sacrifice || 0,
                    row.scores?.stress || 0,
                    row.scores?.relationship || 0,
                    row.rawScores?.dedication || 0,
                    row.rawScores?.sacrifice || 0,
                    row.rawScores?.stress || 0,
                    row.rawScores?.relationship || 0,
                    row.typeIndex || 0,
                    `"${row.userAgent || ''}"`,
                    `"${row.screenResolution || ''}"`,
                    `"${row.language || ''}"`,
                    `"${row.url || ''}"`
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        // CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // JSON„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadJSON(content, filename) {
            const blob = new Blob([content], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
